<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Camera with Sensor Data</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    padding: 10px;
    margin: 0;
  }
  .container {
    max-width: 100%;
    margin: 0 auto;
  }
  video {
    width: 100%;
    max-width: 400px;
    border-radius: 8px;
    background: black;
    display: block;
    margin: 10px auto;
  }
  button {
    font-size: 16px;
    padding: 12px 20px;
    margin: 8px 4px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    min-height: 44px;
  }
  button:disabled {
    background: #666;
    cursor: not-allowed;
  }
  select {
    font-size: 16px;
    padding: 8px;
    margin: 8px 4px;
    background: #333;
    color: white;
    border: 1px solid #555;
    border-radius: 4px;
    min-height: 44px;
  }
  .controls {
    text-align: center;
    margin: 20px 0;
  }
  .status {
    background: #222;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
    text-align: center;
  }
  .error {
    background: #8B0000;
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
  }
  .sensor-data {
    background: #222;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 12px;
    max-height: 300px;
    overflow-y: auto;
  }
  .big-button {
    font-size: 20px;
    padding: 20px 30px;
    background: #FF4444;
    color: white;
    border: none;
    border-radius: 10px;
    width: 90%;
    max-width: 300px;
    margin: 20px auto;
    display: block;
  }
</style>
</head>
<body>

<div class="container">
  <h1 style="text-align: center;">üì± Nothing Phone 2a Camera</h1>
  
  <div id="status" class="status">
    <p><strong>Step 1:</strong> Click "Start Camera" below</p>
    <p>Your browser will ask for camera permission - click "Allow"</p>
  </div>
  
  <div class="controls">
    <button class="big-button" onclick="startCamera()" id="startBtn">üì∑ Start Camera</button>
  </div>
  
  <div class="controls">
    <select id="cameraSelect">
      <option>Loading cameras...</option>
    </select>
    <br>
    <button onclick="switchCamera()" id="switchBtn" disabled>üîÑ Switch Camera</button>
    <button onclick="capturePhoto()" id="captureBtn" disabled>üì∏ Take Photo</button>
  </div>
  
  <video id="video" autoplay playsinline muted style="display: none;"></video>
  
  <div id="error" style="display: none;"></div>
  
  <div class="sensor-data">
    <strong>üì° Sensor Data:</strong>
    <div id="sensorData">Waiting for sensor data...</div>
  </div>
  
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let startBtn = document.getElementById('startBtn');
let captureBtn = document.getElementById('captureBtn');
let switchBtn = document.getElementById('switchBtn');
let cameraSelect = document.getElementById('cameraSelect');
let statusDiv = document.getElementById('status');
let errorDiv = document.getElementById('error');
let sensorDataDiv = document.getElementById('sensorData');

let currentStream = null;
let cameras = [];
let currentCameraIndex = 0;
let sensorData = {
  orientation: {},
  motion: {},
  location: {}
};

// Format sensor values
function fmt(v) {
  return (v == null || isNaN(v)) ? "N/A" : parseFloat(v).toFixed(4);
}

// Update sensor data display
function updateSensorDisplay() {
  const display = `
Orientation:
  Alpha (Z): ${fmt(sensorData.orientation.alpha)}¬∞
  Beta (X):  ${fmt(sensorData.orientation.beta)}¬∞
  Gamma (Y): ${fmt(sensorData.orientation.gamma)}¬∞

Motion Acceleration:
  X: ${fmt(sensorData.motion.x)} m/s¬≤
  Y: ${fmt(sensorData.motion.y)} m/s¬≤
  Z: ${fmt(sensorData.motion.z)} m/s¬≤

Location:
  Latitude:  ${fmt(sensorData.location.lat)}
  Longitude: ${fmt(sensorData.location.lng)}
  Accuracy:  ${fmt(sensorData.location.accuracy)}m

Timestamp: ${new Date().toLocaleTimeString()}
  `;
  sensorDataDiv.textContent = display;
}

// Show error message
function showError(message) {
  errorDiv.style.display = 'block';
  errorDiv.innerHTML = `‚ùå ${message}`;
  console.error(message);
}

// Hide error message
function hideError() {
  errorDiv.style.display = 'none';
}

// Update status
function updateStatus(message) {
  statusDiv.innerHTML = `<p>${message}</p>`;
}

// Get available cameras
async function getCameras() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    cameras = devices.filter(device => device.kind === 'videoinput');
    
    cameraSelect.innerHTML = '';
    cameras.forEach((camera, index) => {
      const option = document.createElement('option');
      option.value = index;
      
      let name = camera.label || `Camera ${index + 1}`;
      if (name.toLowerCase().includes('back') || name.toLowerCase().includes('environment')) {
        name += ' üì∑ (Back)';
      } else if (name.toLowerCase().includes('front') || name.toLowerCase().includes('user')) {
        name += ' ü§≥ (Front)';
      } else if (index === 0) {
        name += ' (Primary)';
      }
      
      option.textContent = name;
      cameraSelect.appendChild(option);
    });
    
    updateStatus(`‚úÖ Found ${cameras.length} camera(s). Camera ready!`);
    return cameras.length > 0;
  } catch (error) {
    showError(`Failed to get cameras: ${error.message}`);
    return false;
  }
}

// Start camera
async function startCamera() {
  try {
    hideError();
    updateStatus('üîÑ Starting camera...');
    
    // Stop any existing stream
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
    }
    
    // Try different approaches for Nothing Phone 2a
    const constraints = [
      // Try back camera first
      {
        video: {
          facingMode: 'environment',
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      },
      // Fallback to any available camera
      {
        video: {
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      },
      // Basic camera request
      {
        video: true
      }
    ];
    
    let stream = null;
    for (const constraint of constraints) {
      try {
        stream = await navigator.mediaDevices.getUserMedia(constraint);
        break;
      } catch (e) {
        console.warn('Constraint failed:', constraint, e.message);
        continue;
      }
    }
    
    if (!stream) {
      throw new Error('Could not access camera');
    }
    
    currentStream = stream;
    video.srcObject = stream;
    video.style.display = 'block';
    
    // Enable controls
    captureBtn.disabled = false;
    switchBtn.disabled = false;
    startBtn.textContent = 'üõë Stop Camera';
    startBtn.onclick = stopCamera;
    
    // Get camera list
    await getCameras();
    
    updateStatus('‚úÖ Camera is active! Ready to take photos.');
    
  } catch (error) {
    showError(`Camera access failed: ${error.message}. Make sure to allow camera permission when prompted.`);
    updateStatus('‚ùå Camera failed to start. Try refreshing the page.');
  }
}

// Stop camera
function stopCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
    currentStream = null;
  }
  
  video.srcObject = null;
  video.style.display = 'none';
  
  captureBtn.disabled = true;
  switchBtn.disabled = true;
  startBtn.textContent = 'üì∑ Start Camera';
  startBtn.onclick = startCamera;
  
  updateStatus('üì± Camera stopped. Click "Start Camera" to begin.');
}

// Switch camera
async function switchCamera() {
  if (cameras.length <= 1) {
    showError('Only one camera available');
    return;
  }
  
  try {
    currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
    const selectedCamera = cameras[currentCameraIndex];
    
    updateStatus('üîÑ Switching camera...');
    
    // Stop current stream
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
    }
    
    // Start new stream with selected camera
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { deviceId: { exact: selectedCamera.deviceId } }
    });
    
    currentStream = stream;
    video.srcObject = stream;
    
    // Update dropdown
    cameraSelect.selectedIndex = currentCameraIndex;
    
    updateStatus(`‚úÖ Switched to: ${selectedCamera.label || 'Camera ' + (currentCameraIndex + 1)}`);
    
  } catch (error) {
    showError(`Failed to switch camera: ${error.message}`);
  }
}

// Capture photo
function capturePhoto() {
  if (!currentStream) {
    showError('No camera stream available');
    return;
  }
  
  try {
    // Set canvas size to video size
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw video frame to canvas
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    // Create filename with sensor data
    const timestamp = Date.now();
    const lat = fmt(sensorData.location.lat);
    const lng = fmt(sensorData.location.lng);
    const alpha = fmt(sensorData.orientation.alpha);
    const beta = fmt(sensorData.orientation.beta);
    const gamma = fmt(sensorData.orientation.gamma);
    
    const filename = `photo_${timestamp}_${lat}_${lng}_${alpha}_${beta}_${gamma}.png`;
    
    // Download image
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      updateStatus(`‚úÖ Photo saved: ${filename}`);
    }, 'image/png');
    
  } catch (error) {
    showError(`Failed to capture photo: ${error.message}`);
  }
}

// Set up sensor listeners
function setupSensors() {
  // Device orientation
  window.addEventListener('deviceorientation', (e) => {
    sensorData.orientation = {
      alpha: e.alpha,
      beta: e.beta,
      gamma: e.gamma
    };
    updateSensorDisplay();
  });
  
  // Device motion
  window.addEventListener('devicemotion', (e) => {
    if (e.acceleration) {
      sensorData.motion = {
        x: e.acceleration.x,
        y: e.acceleration.y,
        z: e.acceleration.z
      };
    }
    updateSensorDisplay();
  });
  
  // Geolocation
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      (position) => {
        sensorData.location = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy
        };
        updateSensorDisplay();
      },
      (error) => {
        sensorData.location = { error: error.message };
        updateSensorDisplay();
      },
      { enableHighAccuracy: true }
    );
  }
}

// Initialize everything
function init() {
  setupSensors();
  updateSensorDisplay();
  
  // Check if camera is supported
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showError('Camera not supported in this browser');
    return;
  }
  
  console.log('Nothing Phone 2a Camera App initialized');
}

// Start when page loads
init();

</script>

</body>
</html>
